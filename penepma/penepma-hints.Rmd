---
title: "penepma hints"
author: "John Minter"
date: "Started: 2018-07-23, Last Modified: 2018-07-25"
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Some key items to remember

1. There are subtle changes between versions. Be sure to to create
material files with `material.exe` and `penepma.exe` from the same
release. The good news is that you can use material input files in
a shell script. Examples are in the `material-input` folder. One
can use a batch/cmd or shell script to generate the files you need
with the appropriate version of `material`.

2. Old `*.dat` files remaining in the folder where penepma is run
can cause unpredictable side effects. I found that on Windows that
batch files had problems with finding `penepma16.exe` in the path,
even though the directory was in the path. It turns out that using
the `bash` shell on Windows (supplied by `git` for Windows) solves
the problem. Now I can use similar shell scripts on both Windows
and MacOS! Below is an example from my Win 7 box:

```
#!/bin/bash
# If you need to kill a simulation and restart, closing the window
# does NOT kill the penepma16 process. Start a task manager and kill
# the penepma16 process BEFORE restarting!
rm -rf *.dat
sleep 1
Penepma < "20-nm-C-coated-EagleXG.in"

sleep 2
```

3. The limit to the number of channels you can compute is with
the default penepma16 is`1000`. I modified the code to permit a
maximum of 4096 channels. If you use the standard version, to get the
best energy resolution when using a high accelerating voltage, for
example 30 kV to get good beam penetration, consider detecting a
smaller energy range.

For our Ir on Ag on silica example, when using the standard version,
I chose to set the `SENERG` value as:

```
>>>>>>>> Electron beam definition.
SENERG 3.0E+04                   [Energy of the electron beam, in eV]
```

and the energy and angular distributions of emerging particles as:

```
       >>>>>>>> Emerging particles. Energy and angular distributions.
NBE    1e1 1.5e4 1000     [E-interval and no. of energy bins 1e3 max]
```

and to make the photon detectors consistent:

```
       >>>>>>>> Photon detectors (up to 25 different detectors).
                IPSF=0, do not create a phase-space file.
                IPSF=1, creates a phase-space file.
       .
PDANGL 50.0 60.0 0.0 360.0 0             [Angular window, in deg, IPSF]
PDENER 1e1 1.5E+04 1000                [Energy window, no. of channels]
```

The performance was OK, but I prefer the modified code...

4. In the `.geo` files, layer thickness values are typically specified
in `microns` or `nm`. These are conveniences for the writer. The real
values are cumulative sums in `cm`. The helper function,
`calculate_penepma_z_shifts()` helps the user get these right.

An example for a typical layer structure is given below. Note that
cumulative shifts are negative!

```{r computeLayerThick, message=FALSE, comment=NA}
library(rpenepma)
# data
l_nm_shifts <- c(500, 250, 1.0e+07)
l_cum_shifts_cm <- calculate_penepma_z_shifts(l_nm_shifts)
print(l_cum_shifts_cm)
```

5. There are some helpful R scripts in the `penepma/R` folder.
The `test-penepma-spec.R` script is helpful for plotting spectra
using `ggplot2`. The script generates a plot with a linear intensity
scale and a plot with a log intensity scale.

6. **A working setup on MacOS**: One issue with `penepma` is that some
programs (`material` and `tables`) need access to the directory of
material parameters (`pdfiles`). I tried putting the three key
executables in (`penepma`, `material`, and `tables`) in a `bin`
directory in my user account and adding that to the `$PATH`. That
worked fine for `penepma` but not `material`, and `tables` when
I tried to run them from my simulation folder. As a workaround,
I created a folder for all my simulations 
(`$HOME/Documents/work/penepma16sims`). I created a folder (`shared`)
inside the `penepma16sims` folder adding the executables  `material`
and `tables` as well as the folder `pdfiles`. Copy the output from
`material` to the appropriate simulation folder inside the main
`penepma16sims` directory. These simulations may be run from
shell scripts inside the directory running `penepma` from the shared
folder. I have thus far been unable to successfully compile the
source from `PenGeomJar` on MacOS with either the current 
`homebrew` gcc compiler (`gcc-8.1.0` and includes `gfortran`) or
the combination of the `gfortran-6.1.pkg` and `clang-6.0.0.pkg` 
currently used by R. These fail with an error message:
`library not found for -lgfortran`.






